version: '3.8'

services:
  backend:
    build:
      context: ./platform/backend
      dockerfile: Dockerfile
    container_name: bhakti-backend
    ports:
      - "${BACKEND_PORT:-8000}:${PORT:-8000}"
    environment:
      - PORT=${PORT:-8000}
      - PYTHONUNBUFFERED=1
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-s3}
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-bhakti}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-bhakti123}
      - S3_BUCKET=${S3_BUCKET:-bhakti-assets}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - ENABLE_YOUTUBE_UPLOAD=${ENABLE_YOUTUBE_UPLOAD:-0}
      - SENTRY_DSN=${SENTRY_DSN:-}
    depends_on:
      - minio
      - create-buckets
    volumes:
      - ./output:/app/output
      - ./jobs:/app/jobs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-8000}/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  frontend:
    build:
      context: ./platform/frontend
      dockerfile: Dockerfile
    container_name: bhakti-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - VITE_API_BASE_URL=http://localhost:${BACKEND_PORT:-8000}
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: bhakti-minio
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      - MINIO_ROOT_USER=${S3_ACCESS_KEY:-bhakti}
      - MINIO_ROOT_PASSWORD=${S3_SECRET_KEY:-bhakti123}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: minio server /data --console-address ":9001"
    restart: unless-stopped

  create-buckets:
    image: minio/mc:latest
    container_name: bhakti-create-buckets
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add myminio http://minio:9000 bhakti bhakti123;
      /usr/bin/mc mb myminio/${S3_BUCKET:-bhakti-assets} --ignore-existing;
      /usr/bin/mc policy set download myminio/${S3_BUCKET:-bhakti-assets};
      exit 0;
      "
    restart: on-failure

  # Optional: Redis for future caching/queuing
  # redis:
  #   image: redis:7-alpine
  #   container_name: bhakti-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   restart: unless-stopped

volumes:
  minio_data:
    driver: local
  # redis_data:
  #   driver: local

networks:
  default:
    name: bhakti-network
    driver: bridge
